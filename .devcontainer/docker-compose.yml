version: '3.8'

services:
  # 1. Serviço da Aplicação (onde o VS Code vai rodar)
  app:
    # Imagem base que já vem com Node.js e Typescript
    image: mcr.microsoft.com/devcontainers/typescript-node:20
    
    volumes:
      # Monta a pasta raiz do projeto (..) para dentro do container
      - ..:/workspace:cached

    # Comando para manter o container vivo para o VS Code se conectar
    command: sleep infinity
    
    # Garante que o banco de dados 'db' inicie primeiro
    depends_on:
      - db
      
    # Variáveis de ambiente que o Nest.js vai usar para se conectar
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: admin
      DB_PASSWORD: admin
      DB_NAME: saude_positiva
      DATABASE_URL: postgresql://admin:admin@db:5432/saude_positiva

  # 2. Serviço do Banco de Dados
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    volumes:
      # Volume para persistir os dados do banco
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Expõe a porta 5432 para o host (Codespace)
      - "5432:5432"
    environment:
      # Credenciais do banco (o Postgres vai criar o DB com isso)
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: saude_positiva

# Define o volume nomeado
volumes:
  postgres_data: